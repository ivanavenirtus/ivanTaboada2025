<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KATO Sandbox</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="icon" href="../assets/icons/logo.png" type="image/png" sizes="24x24">
    <link rel="apple-touch-icon" href="../assets/icons/logo.png" sizes="180x180">
    <script src="https://cdn.jsdelivr.net/pyodide/v0.25.1/full/pyodide.js"></script>
    <script src="../js/main.js" defer></script>
    <style>
        /* Botón container y botón run */
        .btn-container {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 0.5rem;
            /* separa un poco del editor */
        }

        button#run {
            width: 120px;
            font-size: 1.2rem;
            padding: 0.8rem 1.5rem;
            margin: 0;
        }

        .error-line {
            background-color: rgba(255, 0, 0, 0.3);
        }
    </style>
</head>

<body class="subpage">

    <header></header> <!-- Menu dinámico generado por main.js -->

    <main class="wrap section">
        <h2 class="typewriter">Let's code</h2>
        <p class="typewriter desc">Write and run KATO code directly in your browser!</p>

        <div class="editor-wrapper">
            <div class="btn-container">
                <button id="run" class="btn secondary" disabled>Run</button>
            </div>
            <div id="editor" contenteditable="true" spellcheck="false" class="editor"></div>
            <pre id="output"></pre>
        </div>
    </main>

    <script>
        let pyodide;

        async function init() {
            pyodide = await loadPyodide();
            document.getElementById("run").disabled = false;
            document.getElementById("output").textContent = " * Pyodide loaded.";
        }
        init();

        function transpile(code) {
            const lines = code.split(/\r?\n/);
            const result = [];
            for (let line of lines) {
                const leadingSpaces = line.match(/^\s*/)[0].length;
                const indent = Math.floor(leadingSpaces / 4);
                line = line.trim();
                line = line.replace(/\bnew\s+([A-Z]\w*)\b/g, '$1()');
                line = line.replace(/print\s+"([^"]+)"/g, 'print("$1")');
                line = line.replace(/^(if .*|elif .*|else|while .*|for .*|def .*|class .*?)$/, (match) => {
                    return match.endsWith(":") ? match : match + ":";
                });
                if (/^[a-z_]\w*\.[a-z_]\w*$/.test(line)) line = line + "()";
                result.push("    ".repeat(indent) + line);
            }
            return result.join("\n");
        }

        document.getElementById("run").onclick = async () => {
            const editor = document.getElementById("editor");
            const src = editor.innerText;
            const pythonCode = transpile(src);
            const out = document.getElementById("output");
            out.textContent = "";
            editor.innerHTML = editor.innerText; 

            function highlightError(lineNumber) {
                const lines = editor.innerText.split("\n");
                const correctedLine = lineNumber - 1;
                editor.innerHTML = lines.map((line, idx) => {
                    if (idx === correctedLine) return `<span class="error-line">${line}</span>`;
                    return line;
                }).join("\n");
            }

            try {
                await pyodide.runPythonAsync(`import sys, io; sys.stdout = io.StringIO()`);
                await pyodide.runPythonAsync(pythonCode);
                const result = await pyodide.runPythonAsync("sys.stdout.getvalue()");
                out.textContent = result.trim() || "No output.";
            } catch (err) {
                const match = err.toString().match(/File "<exec>", line (\d+)/);
                if (match) highlightError(parseInt(match[1]));
                out.textContent = "X Error de sintaxis:\n" + err;
            }
        };
        const editor = document.getElementById("editor");
        editor.addEventListener("keydown", function (e) {
            if (e.key === "Tab") {
                e.preventDefault();
                const sel = window.getSelection();
                const range = sel.getRangeAt(0);
                const tabNode = document.createTextNode("    ");
                range.insertNode(tabNode);
                range.setStartAfter(tabNode);
                range.setEndAfter(tabNode);
                sel.removeAllRanges();
                sel.addRange(range);
            }
        });
    </script>

</body>

</html>